<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Developer Dashboard | Smart Toll System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: #f3f5f9;
    }
    #map {
      height: 400px;
      width: 100%;
      border-radius: 10px;
    }
    .vehicle-list {
      max-height: 250px;
      overflow-y: auto;
    }
    .card {
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand">Developer Dashboard</a>
      <div>
        <a href="/logout" class="btn btn-outline-light btn-sm">Logout</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <h4>Welcome, Developer</h4>

    <!-- Summary Section -->
    <div class="row mt-3">
      <div class="col-md-4">
        <div class="card p-3 text-center">
          <h6>Total Vehicles</h6>
          <h3>{{ total_vehicles }}</h3>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3 text-center">
          <h6>Total Trips</h6>
          <h3>{{ total_trips }}</h3>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3 text-center">
          <h6>Total Highway Km</h6>
          <h3>{{ highway_sum }}</h3>
        </div>
      </div>
    </div>

    <div class="row mt-4">
      <!-- Vehicle List -->
      <div class="col-md-4">
        <div class="card p-3">
          <h5>Registered Vehicles</h5>
          <div class="vehicle-list list-group">
            {% for v in vehicles %}
              <a href="#" class="list-group-item list-group-item-action vehicle-item" data-vehicle="{{ v.vehicle_no }}">
                {{ v.vehicle_no }} — {{ v.owner_name }}
              </a>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Live Map -->
      <div class="col-md-8">
        <div class="card p-3">
          <h5>Live Map</h5>
          <div id="map"></div>
          <h6 class="mt-3">Real-Time Feed</h6>
          <div id="feed" class="border rounded p-2 bg-light" style="height:120px; overflow-y:auto;"></div>
        </div>
      </div>
    </div>

    <!-- Analytics -->
    <div class="card mt-4 p-3">
      <h5>Analytics Overview</h5>
      <canvas id="tripsChart" height="100"></canvas>
    </div>
  </div>

  <!-- SOCKET + GOOGLE MAPS + CHART -->
  <script>
    const socket = io();

    socket.on("connect", () => {
      console.log("Connected to Socket.IO");
    });

    socket.on("location_update", (data) => {
      const feed = document.getElementById("feed");
      const now = new Date(data.timestamp).toLocaleTimeString();
      const entry = `<div>${now} — <b>${data.vehicle_no}</b> @ ${data.road_name}</div>`;
      feed.innerHTML = entry + feed.innerHTML;

      if (window.updateMarker) {
        window.updateMarker(data.vehicle_no, data.lat, data.lng);
      }
    });

    // Google Maps
    let map;
    let markers = {};
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 12.9716, lng: 77.5946 },
        zoom: 8,
      });

      {% if latest_pings %}
        const latest = {{ latest_pings | tojson | safe }};
        for (const key in latest) {
          const p = latest[key];
          if (p && p.lat && p.lng) {
            placeMarker(p.vehicle_no, p.lat, p.lng);
          }
        }
      {% endif %}
    }

    function placeMarker(vehicle_no, lat, lng) {
      const pos = { lat: lat, lng: lng };
      if (markers[vehicle_no]) {
        markers[vehicle_no].setPosition(pos);
      } else {
        markers[vehicle_no] = new google.maps.Marker({
          position: pos,
          map: map,
          label: vehicle_no
        });
      }
    }

    window.updateMarker = placeMarker;

    // Analytics Chart (mock data)
    const ctx = document.getElementById("tripsChart").getContext("2d");
    const tripsChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Today', '7d', '30d'],
        datasets: [{
          label: 'Trips',
          data: [5, 42, 178],
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  </script>

  <!-- GOOGLE MAPS KEY -->
  <script async src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&callback=initMap"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
