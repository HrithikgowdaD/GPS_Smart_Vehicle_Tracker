<<<<<<< HEAD
{% extends "base.html" %}
{% block content %}
<h3>Developer Dashboard</h3>
<div class="row mb-3">
  <div class="col-md-3">
    <div class="card p-2">
      <h5>Total vehicles</h5>
      <h2>{{ total_vehicles }}</h2>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card p-2">
      <h5>Total trips</h5>
      <h2>{{ total_trips }}</h2>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card p-2">
      <h5>Total highway km</h5>
      <h2>{{ highway_sum }}</h2>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-6">
    <h5>Vehicles</h5>
    <table class="table">
      <thead><tr><th>Vehicle</th><th>Owner</th><th>Balance</th></tr></thead>
      <tbody>
        {% for v in vehicles %}
          <tr>
            <td>{{ v.vehicle_no }}</td>
            <td>{{ v.owner_name or v.owner_name }}</td>
            <td>{{ v.balance or 0 }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="col-md-6">
    <h5>Live Map</h5>
    <div id="map" style="height:400px;border:1px solid #ddd"></div>
    <p class="mt-2">Latest pings will appear as markers. (Requires GOOGLE_MAPS_API_KEY)</p>
  </div>
</div>

<script>
  const GOOGLE_MAPS_API_KEY = "{{ google_maps_key }}";
</script>
<script src="{{ url_for('static', filename='js/dev_dashboard.js') }}"></script>
{% endblock %}
=======
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Developer Dashboard ‚Äî GPS Toll System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #0F172A; }
    .card { border-radius: 1rem; }
    #map { height: 400px; width: 100%; border-radius: 1rem; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand fw-bold">Developer Dashboard</a>
      <div>
        <a href="/logout" class="btn btn-outline-light btn-sm">Logout</a>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <!-- Live Stats -->
    <div class="card shadow-sm p-3 mb-4">
      <h4 class="fw-bold mb-2">Welcome, Developer</h4>
      <div class="row text-center" id="stats">
        <div class="col-md-4">
          <div class="card bg-light p-3">
            <h6>Total Vehicles</h6>
            <h3 id="vehicles-count">{{ total_vehicles }}</h3>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-light p-3">
            <h6>Total Trips</h6>
            <h3 id="trips-count">{{ total_trips }}</h3>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-light p-3">
            <h6>Total Highway Km</h6>
            <h3 id="highway-count">{{ highway_sum }}</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Vehicle Selector -->
    <div class="card shadow-sm p-3 mb-4">
      <h5 class="fw-bold mb-3">Select Vehicle to View</h5>
      <select id="vehicleSelector" class="form-select">
        <option value="">-- Select Vehicle --</option>
        {% for v in vehicles %}
          <option value="{{ v.vehicle_no }}">{{ v.vehicle_no }} ‚Äî {{ v.owner_name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Live Map -->
    <div class="card shadow-sm p-3 mb-4">
      <h5 class="fw-bold mb-3">Live Map (Per Vehicle)</h5>
      <div id="map"></div>
    </div>

    <!-- Vehicle Analytics -->
    <div class="card shadow-sm p-3 mb-4">
      <h5 class="fw-bold mb-3">Vehicle Analytics</h5>
      <div id="vehicleStats" class="text-center text-muted">
        <p>Select a vehicle to view stats...</p>
      </div>
      <canvas id="vehicleChart" height="100"></canvas>
    </div>
  </div>

  <!-- Google Maps & Socket -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCBSyzLTpRbiD0qnQizzuaaqBgwqYme-6A"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <script>
    // üó∫Ô∏è Map Setup
    const map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 12.9716, lng: 77.5946 },
      zoom: 7,
    });

    const markers = {};
    const polylines = {};
    const pathCoords = {}; // store coords for each vehicle
    const socket = io(window.location.origin, { transports: ["websocket"] });
    let selectedVehicle = null;

    socket.on("connect", () => console.log("üü¢ Connected to Socket.IO"));
    socket.on("disconnect", () => console.log("üî¥ Disconnected"));

    // üìç Real-time updates
    socket.on("location_update", (data) => {
      const vno = data.vehicle_no;
      if (!vno || !data.lat || !data.lng) return;
      const pos = { lat: Number(data.lat), lng: Number(data.lng) };

      // Add marker if doesn't exist
      if (!markers[vno]) {
        markers[vno] = new google.maps.Marker({
          position: pos,
          map,
          label: vno,
        });
        pathCoords[vno] = [pos];
        polylines[vno] = new google.maps.Polyline({
          path: pathCoords[vno],
          geodesic: true,
          strokeColor: "#38BDF8",
          strokeOpacity: 0.8,
          strokeWeight: 4,
          map: map,
        });
      } else {
        // Update marker & path
        markers[vno].setPosition(pos);
        pathCoords[vno].push(pos);
        polylines[vno].setPath(pathCoords[vno]);
      }

      if (selectedVehicle === vno) {
        map.panTo(pos);
      }
    });

    // üß≠ Vehicle Selector
    document.getElementById("vehicleSelector").addEventListener("change", async (e) => {
      selectedVehicle = e.target.value;
      if (!selectedVehicle) {
        document.getElementById("vehicleStats").innerHTML = "<p class='text-muted'>Select a vehicle to view stats...</p>";
        return;
      }

      const res = await fetch(`/api/vehicle_stats/${selectedVehicle}`);
      const stats = await res.json();

      if (stats.error) {
        document.getElementById("vehicleStats").innerHTML = `<p class='text-danger'>${stats.error}</p>`;
        return;
      }

      document.getElementById("vehicleStats").innerHTML = `
        <div class="row text-center">
          <div class="col-md-3"><h6>Total Trips</h6><h4>${stats.total_trips}</h4></div>
          <div class="col-md-3"><h6>Total Distance</h6><h4>${stats.total_distance} km</h4></div>
          <div class="col-md-3"><h6>Highway Distance</h6><h4>${stats.total_highway} km</h4></div>
          <div class="col-md-3"><h6>Total Fare</h6><h4>‚Çπ${stats.total_fare}</h4></div>
        </div>
      `;

      updateChart(stats);

      // Center on the selected vehicle's current marker
      if (markers[selectedVehicle]) {
        map.setCenter(markers[selectedVehicle].getPosition());
        map.setZoom(10);
      }
    });

    // üìä Chart.js
    const ctx = document.getElementById("vehicleChart").getContext("2d");
    let vehicleChart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: ["Total Distance", "Highway Distance", "Fare (‚Çπ)"],
        datasets: [{
          label: "Vehicle Stats",
          data: [0, 0, 0],
          backgroundColor: ["#22C55E", "#F87171", "#E5E7EB"],
          borderWidth: 1,
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: "bottom" } }
      }
    });

    function updateChart(stats) {
      vehicleChart.data.datasets[0].data = [
        stats.total_distance,
        stats.total_highway,
        stats.total_fare
      ];
      vehicleChart.update();
    }

    // üîÅ Auto-refresh global stats
    async function refreshStats() {
      try {
        const res = await fetch('/api/live_stats');
        const data = await res.json();
        document.getElementById('vehicles-count').innerText = data.vehicles;
        document.getElementById('trips-count').innerText = data.trips;
        document.getElementById('highway-count').innerText = data.highway_km;
      } catch (err) {
        console.error('Stats refresh failed:', err);
      }
    }

    setInterval(refreshStats, 10000);
  </script>
</body>
</html>
>>>>>>> SIDHU/dashboard-upgrade
