<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SmartToll ‚Äî User Dashboard</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background: linear-gradient(135deg, #a5b4fc, #c084fc);
      min-height: 100vh;
      font-family: 'Poppins', sans-serif;
      color: #1e293b;
    }

    #map {
      height: 450px;
      border-radius: 15px;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .navbar {
      background: linear-gradient(90deg, #6366f1, #8b5cf6);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .legend {
      margin-top: 10px;
      padding: 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      gap: 20px;
      font-size: 14px;
    }

    .legend span {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .color-box {
      width: 16px;
      height: 16px;
      border-radius: 3px;
    }

    .trip-summary {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      margin-top: 20px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .vehicle-row {
      cursor: pointer;
    }

    .vehicle-row:hover {
      background-color: rgba(99, 102, 241, 0.12);
    }

    .qr-thumb {
      cursor: pointer;
      transition: transform 0.2s;
    }

    .qr-thumb:hover {
      transform: scale(1.1);
    }

    #map {
  height: 450px !important;
  width: 100% !important;
  min-height: 450px;
  background: #e5e7eb; /* debug fallback */
}

  </style>
</head>

<body>

  <nav class="navbar navbar-dark px-3">
    <a class="navbar-brand fw-bold" href="#">üöó SmartToll ‚Äî User Dashboard</a>
    <div class="ms-auto">
      <a href="/logout" class="btn btn-outline-light btn-sm">Logout</a>
    </div>
  </nav>

  <div class="container mt-4">
    <h3>Welcome, {{ user.full_name }}</h3>
    <p>Email: {{ user.email }}</p>

    <div class="card mt-3 p-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold mb-0">Your Vehicles</h5>
        <a href="{{ url_for('register_vehicle') }}" class="btn btn-sm btn-primary">‚ûï Add Vehicle</a>
      </div>

      {% if vehicles %}
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Vehicle No</th>
            <th>Owner</th>
            <th>QR Code</th>
            <th>Balance (‚Çπ)</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody>
          {% for v in vehicles %}
          <tr class="vehicle-row" onclick="focusVehicle('{{ v.vehicle_no }}')">

            <td class="fw-semibold">{{ v.vehicle_no }}</td>
            <td>{{ v.owner_name }}</td>

            <!-- ‚úÖ FIXED QR CLICK -->
            <td class="text-center">
              <img
                src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=http://192.168.0.103:5000/vehicle/{{ v.vehicle_no }}"
                width="60" class="border rounded p-1 qr-thumb" onclick="openQR(event, '{{ v.vehicle_no }}')">
              <div class="small text-primary">Click</div>
            </td>

            <td class="fw-bold text-success">
              ‚Çπ{{ "%.2f"|format(v.balance) }}
            </td>

            <td class="d-flex justify-content-center gap-1 flex-wrap">
              <a href="{{ url_for('user_history', vehicle_no=v.vehicle_no) }}" class="btn btn-sm btn-outline-primary">üìú
                History</a>
              <a href="{{ url_for('wallet_add') }}" class="btn btn-sm btn-outline-success">üí∞ Balance</a>
              <button class="btn btn-sm btn-outline-danger">üìç Track</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}
    </div>

    <h5 class="mt-4 fw-bold text-dark">üìç Live Vehicle Tracking</h5>
    <div id="map"></div>

    <div class="legend mt-2">
      <span>
        <div class="color-box" style="background:#2563eb;"></div> Highway
      </span>
      <span>
        <div class="color-box" style="background:#22c55e;"></div> City Road
      </span>
      <span>
        <div class="color-box" style="background:#dc2626;"></div> Toll Zone
      </span>
    </div>
  </div>

  <!-- QR MODAL -->
  <div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-3">
        <h5 class="fw-bold">Vehicle QR Code</h5>
        <p id="qrVehicleNo" class="text-muted"></p>
        <img id="qrBig" class="img-fluid border rounded my-3" style="max-width:260px;">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>



  <script>
    console.log(" USER DASHBOARD JS LOADED");
  </script>
 <script>
let map;
let directionsService;

const markers = {};
const routePolylines = {};

function initMap() {
  console.log("‚úÖ initMap called");

  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 12.9716, lng: 77.5946 },
    zoom: 7,
    mapTypeId: "roadmap",
    gestureHandling: "greedy"
  });

  directionsService = new google.maps.DirectionsService();
}

// üî• SOCKET
const socket = io(window.location.origin, {
  transports: ["polling", "websocket"]
});

socket.on("connect", () => {
  console.log("‚úÖ SOCKET CONNECTED");
});

socket.on("location_update", data => {
  console.log("üìç UPDATE:", data);

  const { vehicle_no, lat, lng } = data;
  const pos = new google.maps.LatLng(lat, lng);

  // First update
  if (!markers[vehicle_no]) {
    markers[vehicle_no] = new google.maps.Marker({
      position: pos,
      map,
      title: vehicle_no
    });

    routePolylines[vehicle_no] = new google.maps.Polyline({
      path: [pos],
      geodesic: true,
      strokeColor: "#2563eb",
      strokeOpacity: 1.0,
      strokeWeight: 5,
      map
    });

    markers[vehicle_no]._lastPos = pos;
    return;
  }

  const origin = markers[vehicle_no]._lastPos;

  // Snap to road and extend polyline
  directionsService.route(
    {
      origin,
      destination: pos,
      travelMode: google.maps.TravelMode.DRIVING
    },
    (result, status) => {
      if (status === "OK") {
        const path = result.routes[0].overview_path;
        const polyPath = routePolylines[vehicle_no].getPath();
        path.forEach(p => polyPath.push(p));
      }
    }
  );

  markers[vehicle_no].setPosition(pos);
  markers[vehicle_no]._lastPos = pos;
});

// ‚úÖ QR FUNCTION MUST BE GLOBAL
function openQR(event, vehicleNo) {
  event.stopPropagation();
  document.getElementById("qrVehicleNo").innerText = vehicleNo;
  document.getElementById("qrBig").src =
    "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" +
    encodeURIComponent("http://192.168.0.103:5000/vehicle/" + vehicleNo);
  new bootstrap.Modal(document.getElementById("qrModal")).show();
}
</script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDwHmT9VfKtdxVyvlO9FUCzbi87tpBWF6E&callback=initMap"
    async defer></script>

</body>

</html>